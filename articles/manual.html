<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>How to use | Bonsai.SLEAP </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="How to use | Bonsai.SLEAP ">
      
      
      <link rel="icon" href="../favicon.ico">
      <link rel="stylesheet" href="../public/docfx.min.css">
      <link rel="stylesheet" href="../public/main.css">
      <meta name="docfx:navrel" content="../toc.html">
      <meta name="docfx:tocrel" content="toc.html">
      
      <meta name="docfx:rel" content="../">
      
      
      <meta name="docfx:docurl" content="https://github.com/bonsai-rx/sleap/blob/main/docs/articles/manual.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">
  </head>

  <script type="module" src="./../public/docfx.min.js"></script>

  <script>
    const theme = localStorage.getItem('theme') || 'auto'
    document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
  </script>


  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../index.html">
            <img id="logo" class="svg" src="../logo.svg" alt="Bonsai - SLEAP">
            Bonsai - SLEAP
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled="" placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" style="margin-top: -.65em; margin-left: -.8em" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="how-to-use">How to use</h1>

<p><code>Bonsai.Sleap</code> currently implements real-time inference on four distinct SLEAP networks through their corresponding Bonsai <code>Predict</code> operators.</p>
<pre><code class="lang-mermaid">flowchart TD

id1(&quot;`**IplImage**`&quot;) --&gt; id7(Multiple Instances)

id1 --&gt; id8(Single Instance)

id7 -- centroid --&gt; id3(&quot;`**PredictCentroids** 

Returns multiple: 
*Centroid*`&quot;)

id7 -- top-down-model --&gt; id4(&quot;`**PredictPoses**

Returns multiple:
*Centroid*, *Pose*`&quot;)


id7 -- top-down-id-model --&gt; id5(&quot;`**PredictPoseIdentities**

Returns multiple:
*Centroid*, *Pose*, *Identity*`&quot;)

id8 -- single_instance --&gt; id2(&quot;`**PredictSinglePose**

Returns single:
*Pose*`&quot;)
</code></pre>
<p>In order to use the <code>Predict</code> operators, you will need to provide the <code>ModelFileName</code> to the exported .pb file folder containing your pre-trained SLEAP model, along with the corresponding <code>PoseConfigFileName</code> to the <code>training_config.json</code> file.</p>
<p>The simplest Bonsai workflow for running the complete SLEAP <code>top-down-id-model</code> is:</p>
<div class="workflow"><p><img src="../workflows/PredictPoseIdentities.bonsai" alt="PredictPoseIdentities"></p>
</div>
<p>If everything works out, you should see some indication in the Bonsai command line window that the GPU was successfully detected and enabled. The first frame will cold start the inference graph and this may take a bit of time, but after that, your poses should start streaming through!</p>
<p><img src="../images/demo.gif" alt="Bonsai_Pipeline_expanded"></p>

<p>Working examples for each of these operators can be found in the extended descriptions, which we cover below.</p>
<h2 id="predictcentroids">PredictCentroids</h2>
<p><a class="xref" href="../api/Bonsai.Sleap.PredictCentroids.html"><code>PredictCentroids</code></a> implements the <a href="https://sleap.ai/develop/api/sleap.nn.config.model.html?highlight=centroid#sleap.nn.config.model.CentroidsHeadConfig"><em>centroid</em> network</a>. This model is most commonly used to find a set of candidate centroids from a full-resolution image. For each frame, it will return a <a class="xref" href="../api/Bonsai.Sleap.CentroidCollection.html"><code>CentroidCollection</code></a> which can be further indexed to access the individual instances.</p>
<p>As an example application, the output of this operator is also fully compatible with the <a class="xref" href="https://bonsai-rx.org/docs/api/Bonsai.Vision.CropCenter.html"><code>CropCenter</code></a> transform node, which can be used to easily generate smaller crops centered on the detected centroid instance (i.e. <a class="xref" href="../api/Bonsai.Sleap.Centroid.html"><code>Centroid</code></a>)</p>
<div class="workflow"><p><img src="../workflows/CentroidModel.bonsai" alt="PredictCentroids"></p>
</div>
<h2 id="predictposes">PredictPoses</h2>
<p><a class="xref" href="../api/Bonsai.Sleap.PredictPoses.html"><code>PredictPoses</code></a> implements the [<em>top-down-model</em> network]. The usual input of this operation will be a sequence of full frames where multiple instances are expected to be found. This operator will output a <a class="xref" href="../api/Bonsai.Sleap.PoseCollection.html"><code>PoseCollection</code></a> with N number of instances found in the image. Indexing a <a class="xref" href="../api/Bonsai.Sleap.PoseCollection.html"><code>PoseCollection</code></a> will return a <a class="xref" href="../api/Bonsai.Sleap.Pose.html"><code>Pose</code></a> where we can access the <a class="xref" href="../api/Bonsai.Sleap.Centroid.html"><code>Centroid</code></a> of each detected instance along with the <a class="xref" href="../api/Bonsai.Sleap.Pose.html"><code>Pose</code></a> containing information on all trained body parts.</p>
<p>To access the data of a specific body part we use the <a class="xref" href="../api/Bonsai.Sleap.GetBodyPart.html"><code>GetBodyPart</code></a>. We set <a class="xref" href="../api/Bonsai.Sleap.GetBodyPart.html#Bonsai_Sleap_GetBodyPart_Name"><code>Name</code></a> to match the part name defined in the <code>training_config.json</code> file. From that moment, the operator will always emit the selected <a class="xref" href="../api/Bonsai.Sleap.BodyPart.html"><code>BodyPart</code></a> object and its inferred position (<a class="xref" href="../api/Bonsai.Sleap.BodyPart.html#Bonsai_Sleap_BodyPart_Position"><code>BodyPart.Position</code></a>).</p>
<div class="workflow"><p><img src="../workflows/TopDownNoIDModel.bonsai" alt="TopDownNoIDModel"></p>
</div>
<h2 id="predictposeidentities">PredictPoseIdentities</h2>
<p><a class="xref" href="../api/Bonsai.Sleap.PredictPoseIdentities.html"><code>PredictPoseIdentities</code></a> evaluates the full SLEAP model network. In addition to extracting pose information for each detected instance in the image, it also returns the inferred identity of the object, i.e. it performs inference on the <a href="https://sleap.ai/develop/api/sleap.nn.config.model.html#sleap.nn.config.model.MultiClassTopDownConfig"><em>top-down-id-model</em> network</a>.</p>
<p>In addition to the properties of the <a class="xref" href="../api/Bonsai.Sleap.Pose.html"><code>Pose</code></a> object, the extended <a class="xref" href="../api/Bonsai.Sleap.PoseIdentity.html"><code>PoseIdentity</code></a> class adds <a class="xref" href="../api/Bonsai.Sleap.PoseIdentity.html#Bonsai_Sleap_PoseIdentity_Identity"><code>Identity</code></a> property that indicates the highest confidence identity. This will match one of the class labels found in <code>training_config.json</code>. The <a class="xref" href="../api/Bonsai.Sleap.PoseIdentity.html#Bonsai_Sleap_PoseIdentity_IdentityScores"><code>IdentityScores</code></a> property indicates the confidence values for all class labels.</p>
<p>Since we are very often only interested in the instance with the highest identification confidence we have added the operator <a class="xref" href="../api/Bonsai.Sleap.GetMaximumConfidencePoseIdentity.html"><code>GetMaximumConfidencePoseIdentity</code></a> which returns the <a class="xref" href="../api/Bonsai.Sleap.PoseIdentity.html"><code>PoseIdentity</code></a> with the highest confidence from the input <a class="xref" href="../api/Bonsai.Sleap.PoseIdentityCollection.html"><code>PoseIdentityCollection</code></a>. Moreover, by specifying a value in the optional <a class="xref" href="../api/Bonsai.Sleap.GetMaximumConfidencePoseIdentity.html#Bonsai_Sleap_GetMaximumConfidencePoseIdentity_Identity"><code>Identity</code></a> property, the operator will return the instance will the highest confidence for that particular class.</p>
<div class="workflow"><p><img src="../workflows/FullTopDownModel.bonsai" alt="FullTopDownModel"></p>
</div>
<h2 id="predictsinglepose">PredictSinglePose</h2>
<p>Almost all SLEAP operators afford the detection of multiple instances for each incoming image. However, in certain cases we might be interested in only identifying a single object in the incoming image. This strategy offers multiple advantages, specifically in terms of performance. In Bonsai.SLEAP, this functionality is implemented using the <a class="xref" href="../api/Bonsai.Sleap.PredictSinglePose.html"><code>PredictSinglePose</code></a> operator that implements a <a href="https://sleap.ai/api/sleap.nn.config.model.html?highlight=centered%20instanc#sleap.nn.config.model.CenteredInstanceConfmapsHeadConfig"><em>single_instance</em> network</a>. Since the centroid detection step is not performed by the network, the operator expects an already centered instance on which it will run the pose estimation. Moreover, the network will always return a single output per incoming frame, even if no valid instances are detected.</p>
<p>The following example workflow highlights how combining <a href="https://circuitdigest.com/tutorial/image-segmentation-using-opencv#:%7E:text=Image%20segmentation%20is%20a%20process,the%20parts%20of%20an%20image.">basic computer-vision algorithm for image segmentation</a> for centroid detection, with the network-based pose estimation, results in &gt;2-fold increases in performance relative to the previously introduced <a class="xref" href="../api/Bonsai.Sleap.PredictPoses.html"><code>PredictPoses</code></a> operator. In this example, the first part of the workflow segments and detects the centroid positions (output of <a class="xref" href="https://bonsai-rx.org/docs/api/Bonsai.Vision.BinaryRegionAnalysis.html"><code>BinaryRegionAnalysis</code></a>) of all available objects in the incoming frame, which are then combined with the original image to generate centered crops (<a class="xref" href="https://bonsai-rx.org/docs/api/Bonsai.Vision.CropCenter.html"><code>CropCenter</code></a>). These images are then pushed through the network that will perform the pose estimation step of the process.</p>
<div class="workflow"><p><img src="../workflows/SingleInstanceModel.bonsai" alt="SingleInstanceModel"></p>
</div>
<p>Finally, it is worth noting that <a class="xref" href="../api/Bonsai.Sleap.PredictSinglePose.html"><code>PredictSinglePose</code></a> affords two input overloads. When receiving a single image it will output a corresponding <a class="xref" href="../api/Bonsai.Sleap.Pose.html"><code>Pose</code></a>. Since the operator skips the centroid-detection stage, it won't embed a <a class="xref" href="../api/Bonsai.Sleap.Centroid.html"><code>Centroid</code></a> field in <a class="xref" href="../api/Bonsai.Sleap.Pose.html"><code>Pose</code></a>. Alternatively, a <em>batch</em> mode can be accessed by providing an array of images to the operator, instead returning <a class="xref" href="../api/Bonsai.Sleap.PoseCollection.html"><code>PoseCollection</code></a>. This latter overload results in dramatic performance gains relative to single images.</p>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/bonsai-rx/sleap/blob/main/docs/articles/manual.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          &copy; 2024 Bonsai Foundation CIC and Contributors. Made with <a href="https://dotnet.github.io/docfx">docfx</a>
        </div>
      </div>
    </footer>
  </body>
</html>
